#######################################################
# Setup the global variables
#######################################################

# The name of this server
Define SERVER_NAME viral32111.local

# The contact email address
Define CONTACT_EMAIL contact@viral32111.com

# The directory of the public files to serve
Define WEB_DIRECTORY /home/viral32111/repositories/viral32111/viral32111.local/public

# The directory where the SSL certificates and keys are located
Define SSL_DIRECTORY /home/viral32111/ssl/issued/${SERVER_NAME}

# The directory to write access and error logs into
Define LOG_DIRECTORY /var/log/apache2/${SERVER_NAME}

#######################################################
# Configure global options
#######################################################

# The format to use for the access logs
LogFormat "[%{%d/%m/%Y %H:%M:%S}t.%{msec_frac}t %{%z}t, %{us}T] [%{UNIQUE_ID}e] [%{SSL_SESSION_ID}e] %a:%{remote}p (%{__Secure-ID}C, %u) %A:%{local}p (%v) %H %{SSL_PROTOCOL}e (%{SSL_CIPHER}e) %m \"%U%q\" %R %>s %I %O %k %X \"%{User-Agent}i\" \"%{From}i\" \"%{Referer}i\" \"%{DNT}i\" \"%{Cache-Control}o\" \"%{Content-Type}o\"" custom

# Only send product information in the Server response header
ServerTokens ProductOnly

#######################################################
# Configure the public files directory
#######################################################

<Directory ${WEB_DIRECTORY}>

	# Prevent the use of overrides in .htaccess files
	AllowOverride None

	# Enable autoindexing directories
	Options +Indexes

	# Set the autoindexing options
	IndexOptions FoldersFirst FancyIndexing HTMLTable IconsAreLinks SuppressDescription SuppressLastModified IgnoreClient SuppressSize SuppressRules NameWidth=*
	IndexHeadInsert "<link rel=\"stylesheet\" href=\"/css/global.css\" type=\"text/css\"> <link rel=\"stylesheet\" href=\"/css/header.css\" type=\"text/css\"> <link rel=\"stylesheet\" href=\"/css/content.css\" type=\"text/css\"> <link rel=\"stylesheet\" href=\"/css/footer.css\" type=\"text/css\">"
	HeaderName /template/index_header.html
	ReadmeName /template/index_footer.html

	# Enable following file and directory symlinks
	Options +FollowSymLinks

	# Allow everyone to access this website
	Require all granted

</Directory>

#######################################################
# Create the insecure virtualhost
#######################################################

<VirtualHost *:80>

	# Enable required engines
	RewriteEngine On

	# The name of this server
	ServerName ${SERVER_NAME}
	ServerAlias www.${SERVER_NAME}

	# The contact email address of this server
	ServerAdmin ${CONTACT_EMAIL}

	# The path and format of the access log file
	CustomLog ${LOG_DIRECTORY}/access.log custom

	# The path of the forensic log file
	ForensicLog ${LOG_DIRECTORY}/forensic.log

	# The verbosity level, path and format of the error log file
	LogLevel info ssl:warn
	ErrorLog ${LOG_DIRECTORY}/error.log
	ErrorLogFormat "[%t] [%{UNIQUE_ID}e, %{c}L] [%{SSL_SESSION_ID}e] %a (\"%-{Cookie}i\", \"%-{User-Agent}i\", \"%-{From}i\", \"%-{Referer}i\") %A (%v) (%-m:%l, %P) %F: %M (%E)"

	# Disable the signature footer on server generated documents
	ServerSignature Off

	# Always redirect to the secure server
	RewriteCond %{HTTPS} =off
	RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [R=308,L]

</VirtualHost>

#######################################################
# Create the secure virtualhost
#######################################################

<VirtualHost *:443>

	# Enable required engines
	RewriteEngine On
	SSLEngine On

	# The name of this server
	ServerName ${SERVER_NAME}
	ServerAlias www.${SERVER_NAME}

	# The contact email address of this server
	ServerAdmin ${CONTACT_EMAIL}

	# The path to the public files directory
	DocumentRoot ${WEB_DIRECTORY}

	# The path and format of the access log file
	CustomLog ${LOG_DIRECTORY}/access.log custom

	# The path of the forensic log file
	ForensicLog ${LOG_DIRECTORY}/forensic.log

	# The verbosity level, path and format of the error log file
	LogLevel info ssl:warn
	ErrorLog ${LOG_DIRECTORY}/error.log
	ErrorLogFormat "[%t] [%{UNIQUE_ID}e, %{c}L] [%{SSL_SESSION_ID}e] %a (\"%-{Cookie}i\", \"%-{User-Agent}i\", \"%-{From}i\", \"%-{Referer}i\") %A (%v) (%-m:%l, %P) %F: %M (%E)"

	# Disable the signature footer on server generated documents
	ServerSignature Off

	# Enable SSL environment variables
	SSLOptions +StdEnvVars

	# Set PHP's error handling configuration to output every error in plaintext - turn these off in production
	php_admin_value error_reporting -1
	php_admin_flag display_errors On
	php_admin_flag display_startup_errors On
	php_admin_flag html_errors Off

	# Set PHP's session storage & cookie configuration
	php_admin_value session.name __Secure-ID
	php_admin_value session.cache_limiter private_no_expire
	php_admin_value session.cache_expire 60
	php_admin_value session.cookie_lifetime 315576000
	php_admin_value session.cookie_path /
	php_admin_value session.cookie_domain .${SERVER_NAME}
	php_admin_value session.cookie_samesite Strict
	php_admin_flag session.cookie_secure On
	php_admin_flag session.cookie_httponly On

	# Set PHP's timezone to UTC for date & time related functionality
	php_admin_value date.timezone UTC

	# Set PHP's include path to the public web directory
	php_admin_value include_path ${WEB_DIRECTORY}

	# The paths to the SSL certificate and private key
	SSLCertificateFile ${SSL_DIRECTORY}/certificate.crt
	SSLCertificateKeyFile ${SSL_DIRECTORY}/secret.key

	# Only use modern TLS protocols
	SSLProtocol TLSv1.3 +TLSv1.2 -TLSv1.1 -TLSv1 -SSLv3 -SSLv2

	# Only use the strongest encryption ciphers
	SSLCipherSuite HIGH:!MEDIUM:!LOW:!MD5:!SHA1:!TLSv1:!SSLv3
	SSLHonorCipherOrder On

	# Always redirect to the non-www host for this server
	RewriteCond %{HTTP_HOST} ^www\.
	RewriteRule ^ %{REQUEST_SCHEME}://${SERVER_NAME}%{REQUEST_URI} [R=308,L]

	# This server will never have favicon.ico
	RewriteRule ^/favicon.ico$ - [G,L]

	# Deny image requests that did not originate from this website (but still allow direct access)
	RewriteCond %{HTTP_REFERER} !^$
	RewriteCond %{HTTP_REFERER} !${SERVER_NAME} [NC]
	RewriteRule \.(ico|gif|jpg|jpeg|png|webp|svg)$ - [F,L]

	# Setup custom error pages
	#ErrorDocument 307 /error.php
	#ErrorDocument 308 /error.php
	ErrorDocument 403 /error.php
	ErrorDocument 404 /error.php
	ErrorDocument 410 /error.php
	ErrorDocument 500 /error.php

	# Make the error & index page without .php extension seem like they do not exist
	RewriteRule ^/(index|error)$ - [R=404,L]

	# Make documents accessed with the .php extension seem like they do not exist
	RewriteCond ${WEB_DIRECTORY}/%{REQUEST_URI} -f
	RewriteCond %{ENV:REDIRECT_STATUS} ^$
	RewriteRule \.php$ - [R=404,L]

	# Allow accessing documents without the .php extension
	RewriteCond ${WEB_DIRECTORY}/%{REQUEST_URI}.php -f
	RewriteRule ^ %{REQUEST_URI}.php [L]

	# Rules in here apply to all documents (except error documents)
	<Location />

		# Add subsitution to the output filter of HTML content
		AddOutputFilterByType SUBSTITUTE text/html

		# Remove HTML comments
		Substitute s/<!--.*-->//q

		# Remove leading whitespace and empty lines
		Substitute s/^\s+//q

	</Location>

	# Rules in here apply to all documents inside the stylesheets directory
	<Location /css/>

		# Add subsitution to the output filter of CSS content
		AddOutputFilterByType SUBSTITUTE text/css

		# Remove whitespace after selector
		Substitute s/\s{/{/q

		# Remove property key-value whitespace
		Substitute s/:\s/:/q

		# Remove CSS comments
		Substitute s|\/\*.*\*\/||q

		# Remove leading whitespace and empty lines
		Substitute s/^\s+//q

		# Remove new lines inside declarations
		Substitute s/;\n/;/q

	</Location>

</VirtualHost>
