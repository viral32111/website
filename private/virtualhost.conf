#######################################################
# Setup the global variables
#######################################################

# The name of this server
Define SERVER_NAME viral32111.local

# The contact email address
Define CONTACT_EMAIL contact@viral32111.com

# The directory of the public files to serve
Define WEB_DIRECTORY /home/viral32111/repositories/viral32111/viral32111.local/public

# The directory where the SSL certificates and keys are located
Define SSL_DIRECTORY /home/viral32111/ssl/issued/${SERVER_NAME}

# The directory to write access and error logs into
Define LOG_DIRECTORY /var/log/apache2/${SERVER_NAME}

#######################################################
# Configure global options
#######################################################

# The format to use for the access logs
LogFormat "[%{%d/%m/%Y %H:%M:%S}t.%{msec_frac}t %{%z}t, %{us}T] [%{UNIQUE_ID}e] [%{SSL_SESSION_ID}e] %a:%{remote}p (%{__Secure-ID}C, %u) %A:%{local}p (%v) %H %{SSL_PROTOCOL}e (%{SSL_CIPHER}e) %m \"%U%q\" %R %>s %I %O %k %X \"%{User-Agent}i\" \"%{From}i\" \"%{Referer}i\" \"%{DNT}i\" \"%{Cache-Control}o\" \"%{Content-Type}o\"" custom

# Only send product information in the Server response header
ServerTokens ProductOnly

#######################################################
# Configure the public files directory
#######################################################

<Directory ${WEB_DIRECTORY}>

	# Prevent the use of overrides in .htaccess files
	AllowOverride None

	# Disable autoindexing directories
	Options -Indexes

	# Enable following file and directory symlinks
	Options +FollowSymLinks

	# Allow everyone to access this website
	Require all granted

</Directory>

#######################################################
# Create the insecure virtualhost
#######################################################

<VirtualHost *:80>

	# Enable required engines
	RewriteEngine On

	# The name of this server
	ServerName ${SERVER_NAME}
	ServerAlias www.${SERVER_NAME}

	# The path and format of the access log file
	CustomLog ${LOG_DIRECTORY}/access.log custom

	# The path of the forensic log file
	ForensicLog ${LOG_DIRECTORY}/forensic.log

	# The path and verbosity level of the error log file
	LogLevel info
	ErrorLog ${LOG_DIRECTORY}/error.log

	# Disable the signature footer on server generated documents
	ServerSignature Off

	# Always redirect to the secure server
	RewriteCond %{HTTPS} =off
	RewriteRule .* https://%{HTTP_HOST}%{REQUEST_URI} [R=308,L]

</VirtualHost>

#######################################################
# Create the secure virtualhost
#######################################################

<VirtualHost *:443>

	# Enable required engines
	RewriteEngine On
	SSLEngine On

	# The name of this server
	ServerName ${SERVER_NAME}
	ServerAlias www.${SERVER_NAME}

	# The path to the public files directory
	DocumentRoot ${WEB_DIRECTORY}

	# The path and format of the access log file
	CustomLog ${LOG_DIRECTORY}/access.log custom

	# The path of the forensic log file
	ForensicLog ${LOG_DIRECTORY}/forensic.log

	# The path and verbosity level of the error log file
	LogLevel info ssl:warn
	ErrorLog ${LOG_DIRECTORY}/error.log

	# Disable the signature footer on server generated documents
	ServerSignature Off

	# Enable SSL environment variables
	SSLOptions +StdEnvVars

	# Set PHP's session configuration
	php_admin_value session.name __Secure-ID
	php_admin_value session.cache_limiter private_no_expire
	php_admin_value session.cache_expire 60
	php_admin_value session.cookie_lifetime 315576000
	php_admin_value session.cookie_path /
	php_admin_value session.cookie_domain .${SERVER_NAME}
	php_admin_value session.cookie_samesite Strict
	php_admin_flag session.cookie_secure on
	php_admin_flag session.cookie_httponly on

	# Set PHP's include path
	php_admin_value include_path ${WEB_DIRECTORY}

	# The paths to the SSL certificate and private key
	SSLCertificateFile ${SSL_DIRECTORY}/certificate.crt
	SSLCertificateKeyFile ${SSL_DIRECTORY}/secret.key

	# Only use the strongest TLS protocols
	SSLProtocol TLSv1.3 +TLSv1.2 -TLSv1.1 -TLSv1 -SSLv3 -SSLv2

	# Only use the strongest encryption ciphers
	SSLCipherSuite HIGH:!MEDIUM:!LOW:!MD5:!SHA1:!TLSv1:!SSLv3
	SSLHonorCipherOrder On

	# This server will never have favicon.ico
	RewriteCond %{REQUEST_URI} =/favicon.ico
	RewriteRule .* - [G,L]

	# Always redirect to non-www host for this server
	RewriteCond %{HTTP_HOST} ^www\.
	RewriteRule .* %{REQUEST_SCHEME}://${SERVER_NAME}%{REQUEST_URI} [R=308,L]

</VirtualHost>
