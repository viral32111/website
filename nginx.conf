# Disable cache by default
expires off;

# Cache text files for 1 month
location ~* .txt$ {
	expires 30d;
	add_header Cache-Control "public, no-transform";
}

# Cache stylesheets & images for 7 days
location ~* ^/(download|stylesheet|image) {
	expires 7d;
	add_header Cache-Control "public, no-transform";
}

# Cache downloads for 1 month
location ~* ^/download/ {
	expires 30d;
	add_header Cache-Control "public, no-transform";
}

# Security enhancing headers
#add_header X-XSS-Protection "0" always;
add_header X-Frame-Options "DENY" always;
add_header X-Content-Type-Options "nosniff" always;
add_header Referrer-Policy "same-origin" always;
add_header Content-Security-Policy "default-src 'none'; base-uri 'self'; style-src 'self'; script-src 'self'; img-src 'self'; media-src 'self'; frame-ancestors 'none'; form-action 'none'; upgrade-insecure-requests;" always;
if ( $https = on ) { # Only set HSTS on HTTPS connections
	add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
}

# Inform Tor Browser visitors of the hidden service on successful responses
add_header Onion-Location "http://viraldwfella5we7pdbi75pmzg4bcrehcwjstyy6tgjbqhdh6pgdi6yd.onion$request_uri";

# Prevent page archives and image indexing
add_header X-Robots-Tag "noarchive, noimageindex";

# Redirect root to homepage
location = / { return 307 /home; }

# Redirect pages ending in .html to pages without the extension
location ~ \.html$ {
	rewrite ^(.*)\.html$ $1 permanent;
}

# Allow access to pages without the .html extension
location / {
	try_files $uri $uri.html =404;
}

# There will never be a favicon
location = /favicon.ico { return 410; }

# Third-party/social redirects
location = /twitter { return 308 https://twitter.com/viral32111; }
location = /steam { return 308 https://steamcommunity.com/profiles/76561198168833275; }
location = /reddit { return 308 https://reddit.com/user/viral32111; }
location = /deviantart { return 308 https://www.deviantart.com/viral32111; }
location = /youtube { return 308 https://www.youtube.com/channel/UCgnd0UhrusfKlz1VJWmjEFQ; }
location = /twitch { return 308 https://www.twitch.tv/viral32111; }
location = /namemc { return 308 https://namemc.com/profile/a51dccb5-7ffa-426b-833b-1a9ce3a31446; }
location = /myanimelist { return 308 https://myanimelist.net/profile/viral32111; }
location = /github { return 308 https://github.com/viral32111; }
location = /gmodstore { return 308 https://www.gmodstore.com/users/76561198168833275; }
location = /discord { return 308 https://discord.com/invite/PdzSFsh; }
location = /steamgroup { return 308 https://steamcommunity.com/groups/conspiracyservers; }
location = /matrix { return 308 https://matrix.to/#/#viral32111:matrix.org; }
location = /teamspeak { return 308 https://tmspk.gg/uhy9DJwL; }
location = /revolt { return 308 https://app.revolt.chat/invite/axj330h2; }
location = /instagram { return 308 https://www.instagram.com/viral32111/; }
location = /threads { return 308 https://www.threads.net/@viral32111; }
location = /mastodon { return 308 https://mastodon.online/@viral32111; }

# Notice for deprecated third-party redirects
location = /paypal { return 410 'Redirect no longer available'; }
location = /apply { return 410 'Redirect no longer available'; }
location = /map-vote { return 410 'Redirect no longer available'; }
location = /join-sandbox { return 410 'Redirect no longer available'; }
location = /ttt { return 410 'Redirect no longer available'; }
location = /sandbox-addon-vote { return 410 'Redirect no longer available'; }
location = /spacebuild-vote { return 410 'Redirect no longer available'; }
location = /appeal { return 410 'Redirect no longer available'; }
location = /sandbox { return 410 'Redirect no longer available'; }
location = /spacebuild { return 410 'Redirect no longer available'; }
location = /report { return 410 'Redirect no longer available'; }

# Redirects for easier page access
location = /xmr { return 308 /xmr.txt; }
location = /btc { return 308 /btc.txt; }
location = /.well-known/security.txt { return 308 /security.txt; }

# Notice for deprecated page redirects
location = /link { return 410 'Page no longer available'; }
location = /steamuser { return 410 'Page no longer available'; }
location = /staff { return 410 'Page no longer available'; }
location = /members { return 410 'Page no longer available'; }
location = /advertisement { return 410 'Page no longer available'; }
location = /report/csp { return 410 'Page no longer available'; }
location = /report/csp.php { return 410 'Page no longer available'; }
location = /report/hpkp { return 410 'Page no longer available'; }
location = /report/hpkp.php { return 410 'Page no longer available'; }
location = /report/transparency { return 410 'Page no longer available'; }
location = /report/transparency.php { return 410 'Page no longer available'; }
location = /report/xss { return 410 'Page no longer available'; }
location = /report/xss.php { return 410 'Page no longer available'; }

# Redirects for backwards compatibility
location = /stylesheet/ { return 308 /stylesheets/; }
location = /image/ { return 308 /images/; }
location = /image/avatar/ { return 308 /images/avatar/; }
location = /image/avatar/circle-448.webp { return 308 /images/avatar/embed.webp; }
location = /images/steam-default-avatar.png { return 308 "https://avatars.akamai.steamstatic.com/fef49e7fa7e1997310d705b2a6158ff8dc1cdfeb_full.jpg"; }
location = /minecraft-1.16.5-world.tar.xz { return 308 /download/minecraft-1.16.5-world.tar.xz; }
location = /minecraft-1.18-snapshot-world.zip { return 308 /download/minecraft-1.18-snapshot-world.zip; }
location = /minecraft-1.18-world.zip { return 308 /download/minecraft-1.18-world.zip; }
