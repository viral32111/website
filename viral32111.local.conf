# The server's name
Define SERVER_NAME viral32111.local

# Directory configurations
Define WEB_DIRECTORY /srv/www/${SERVER_NAME}
Define LOG_DIRECTORY /var/log/apache2/${SERVER_NAME}
Define SSL_DIRECTORY /home/viral32111/ssl/issued/${SERVER_NAME}
Define GIT_DIRECTORY /home/viral32111/repositories/viral32111/viral32111.local

# Webmaster contact email
ServerAdmin contact@viral32111.com

# Document root configuration
<Directory ${WEB_DIRECTORY}>
	# Disable directory indexing
	Options -Indexes
</Directory>

# Insecure
<VirtualHost *:80>
	# Enable rewrites
	RewriteEngine On

	# The server's hostname
	ServerName ${SERVER_NAME}
	ServerAlias www.${SERVER_NAME}

	# Path to web root directory
	DocumentRoot ${WEB_DIRECTORY}/${SERVER_NAME}

	# Path to the error log
	ErrorLog ${LOG_DIRECTORY}/${SERVER_NAME}/error.log

	# Path to the access log
	CustomLog ${LOG_DIRECTORY}/${SERVER_NAME}/access.log combined

	# Permanently redirect to the HTTPs version of whatever page was requested
	RewriteCond %{HTTPS} "=off"
	RewriteRule "^/?(.*)" "https://${SERVER_NAME}/$1" [R=308,L]

	# Store that permanent redirect in any cache for up to 1 month
	Header always set Cache-Control "public, max-age=2629800" "expr=%{REQUEST_STATUS} == 308"
</VirtualHost>

# Secure
<VirtualHost *:443>
	# Enable rewrites
	RewriteEngine On

	# Enable TLS
	SSLEngine On

	# The server's hostname
	ServerName ${SERVER_NAME}
	ServerAlias www.${SERVER_NAME}

	# Path to web root directory
	DocumentRoot ${WEB_DIRECTORY}/${SERVER_NAME}

	# Path to the error log
	ErrorLog ${LOG_DIRECTORY}/${SERVER_NAME}/error.log

	# Path to the access log
	CustomLog ${LOG_DIRECTORY}/${SERVER_NAME}/access.log combined

	# Send access logs to a database
	#LogSQLTransferLogTable logs_test
	#LogSQLLoginInfo "mysql://apache:PtMSvNXedBrffhH7y7RbzjVBNqMB7rf8@192.168.0.4:32400/ViralsWebsite"
	#LogSQLCreateTables on
	#LogSQLDBParam socketfile /var/run/mysqld/mysqld.sock
	#LogSQLTransferLogFormat AbHhmRSsTUuvI

	# Certificate and private key location
	SSLCertificateFile ${SSL_DIRECTORY}/certificate.crt
	SSLCertificateKeyFile ${SSL_DIRECTORY}/secret.key

	# Only allow modern TLS protocols
	SSLProtocol TLSv1.3 +TLSv1.2 -TLSv1.1 -TLSv1 -SSLv3 -SSLv2

	# Only use the highest security ciphers
	SSLCipherSuite HIGH:!MEDIUM:!LOW:!MD5:!SHA1:!TLSv1:!SSLv3
	SSLHonorCipherOrder On

	# Permanently redirect to non-www. version of the website
	RewriteCond %{HTTP_HOST} ^www\.
	RewriteRule ^.*$ "https://${SERVER_NAME}%{REQUEST_URI}" [R=308,L]

	# Expose SSL environment variables for PHP scripts
	#SSLOptions +StdEnvVars

	# Provide onionsite for Tor Browser users on successful responses
	Header set Onion-Location "http://viralcra3zyjdrnx2mzve6vn7sdwodwbngrc266s5ybmln3dac3mvhad.onion%{REQUEST_URI}s" "expr=%{REQUEST_STATUS} == 200"
	Header set Onion-Location "http://viralcra3zyjdrnx2mzve6vn7sdwodwbngrc266s5ybmln3dac3mvhad.onion%{REQUEST_URI}s?%{QUERY_STRING}s" "expr=-n %{QUERY_STRING} && %{REQUEST_STATUS} == 200"

	# Do not store anything in any cache by default
	Header always set Cache-Control "no-store"

	# Store static content in any cache for up to 1 day
	Header always set Cache-Control "public, max-age=86400" "expr=%{REQUEST_URI} =~ m#\.css|\.png$#"

	# Always include the processing time in microseconds
	Header always set Processing-Time "%D"
	Header always edit Processing-Time "D=" ""

	# Always include the unix timestamp in microseconds of when the request was received
	Header always set Request-Received "%t"
	Header always edit* Request-Received "^t=(\d+)$" "$1"

	# Set PHP's timezone to UTC
	php_admin_value date.timezone UTC
	php_admin_flag display_errors 1

	# Set environment variables for PHP script configurations
	SetEnv CONFIG_GNUPG_HOME ${GIT_DIRECTORY}/gnupg
	SetEnv CONFIG_GIT_DIRECTORY ${GIT_DIRECTORY}
	SetEnv CONFIG_DATETIME_FORMAT_REGULAR "l jS F Y, H:i:s T"
	SetEnv CONFIG_DATETIME_FORMAT_PRECISE "l jS F Y, H:i:s.v T"

	# Set custom error pages
	ErrorDocument 404 /index.php

	# Does the request URI end with '/'?
	#<If "%{REQUEST_URI} =~ m#/$#">
		# Set REQUEST_PATH to '$1/index'
	#	SetEnvIf Request_URI "^(.*)/$" REQUEST_PATH="$1/index"
	#</If>
	#<Else>
		# Set REQUEST_PATH to REQUEST_URI
	#	SetEnvIf Request_URI "^(.*)$" REQUEST_PATH="$1"
	#</Else>

	# If the requested file exists as a markdown content file & isn't a file in the document root
	#<If "-f '/home/viral32111/repositories/viral32111/viral32111.local/content%{REQUEST_URI}.md' && ! -f '/home/viral32111/repositories/viral32111/viral32111.local/docroot%{REQUEST_URI}'">
		# Process this request with the content processor script
	#</If>

	# We will never have /favicon.ico
	RewriteCond "%{REQUEST_URI}" "=/favicon.ico"
	RewriteRule ".*" "-" [G,L]

	# Redirect to template if the request URI is '/'
	RewriteCond "%{REQUEST_URI}" "^/?$"
	RewriteRule ^/(.*)$ /index.php [QSA,E=PAGE:index,L]

	# Redirect to the template if no PHP file exists in the web root, the content markdown file exists & the URI doesn't end in '/index'
	RewriteCond ${WEB_DIRECTORY}/${SERVER_NAME}%{REQUEST_URI}.php !-f
	RewriteCond ${GIT_DIRECTORY}/content%{REQUEST_URI}.md -f
	RewriteCond "%{REQUEST_URI}" "!/index$"
	RewriteRule ^/(.+)$ /index.php [QSA,E=PAGE:$1,L]

	# Redirect to the template if no PHP file exists in the web root, the URI doesn't end in '/', the content directory exists & the content directory's index markdown file exists
	RewriteCond ${WEB_DIRECTORY}/${SERVER_NAME}%{REQUEST_URI}.php !-f
	RewriteCond "%{REQUEST_URI}" "!/$"
	RewriteCond ${GIT_DIRECTORY}/content%{REQUEST_URI} -d
	RewriteCond ${GIT_DIRECTORY}/content%{REQUEST_URI}/index.md -f
	RewriteRule ^/(.+)$ /index.php [QSA,E=PAGE:$1/index,L]

	# Remove the need for the .php extension for files that exist in the web directory
	RewriteCond ${WEB_DIRECTORY}/${SERVER_NAME}%{REQUEST_URI} !-d
	RewriteCond ${WEB_DIRECTORY}/${SERVER_NAME}%{REQUEST_URI}.php -f
	RewriteRule ^/(.+)$ %{REQUEST_URI}.php [L]

	# Minify the output of PHP files
	<FilesMatch ".+\.php$">
		# Filter PHP through these filters
		AddOutputFilter "SUBSTITUTE;DEFLATE" php

		# Remove HTML comments
		Substitute "s/<!--.*-->//q"

		# Remove leading whitespace
		Substitute "s/^\s+//q"

		# Remove new lines
		#Substitute "s/\n$//q"
	</FilesMatch>
</VirtualHost>
