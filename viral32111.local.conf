# The server's name
Define SERVER_NAME viral32111.local

# Directory configurations
Define WEB_DIRECTORY /srv/www/${SERVER_NAME}
Define LOG_DIRECTORY /var/log/apache2/${SERVER_NAME}
Define SSL_DIRECTORY /home/ubuntu2004/ssl/issued/${SERVER_NAME}
Define CONTENT_DIRECTORY /home/ubuntu2004/github-repositories/viral32111/viral32111.local/content

# Server admin email
ServerAdmin contact@${SERVER_NAME}

# Insecure
<VirtualHost *:80>
	# The server's hostname
	ServerName ${SERVER_NAME}
	ServerAlias www.${SERVER_NAME}

	# Path to web root directory
	DocumentRoot ${WEB_DIRECTORY}/${SERVER_NAME}

	# Path to the error log
	ErrorLog ${LOG_DIRECTORY}/${SERVER_NAME}/error.log

	# Path to the access log
	CustomLog ${LOG_DIRECTORY}/${SERVER_NAME}/access.log combined
</VirtualHost>

# Secure
<VirtualHost *:443>
	# The server's hostname
	ServerName ${SERVER_NAME}
	ServerAlias www.${SERVER_NAME}

	# Path to web root directory
	DocumentRoot ${WEB_DIRECTORY}/${SERVER_NAME}

	# Path to the error log
	ErrorLog ${LOG_DIRECTORY}/${SERVER_NAME}/error.log

	# Path to the access log
	CustomLog ${LOG_DIRECTORY}/${SERVER_NAME}/access.log combined

	# Enable TLS
	SSLEngine On

	# Certificate and private key location
	SSLCertificateFile ${SSL_DIRECTORY}/certificate.crt
	SSLCertificateKeyFile ${SSL_DIRECTORY}/secret.key

	# Only allow modern TLS protocols
	SSLProtocol TLSv1.3 +TLSv1.2 -TLSv1.1 -TLSv1 -SSLv3 -SSLv2

	# Only use the highest security ciphers
	SSLCipherSuite HIGH:!MEDIUM:!LOW:!MD5:!TLSv1:!SSLv3:!aNULL:!eNULL:!NULL:!EXP
	SSLHonorCipherOrder On

	# Expose SSL environment variables for PHP scripts
	# SSLOptions +StdEnvVars

	# Provide onion website for Tor Browser users for successful responses
	Header set Onion-Location "http://viralcra3zyjdrnx2mzve6vn7sdwodwbngrc266s5ybmln3dac3mvhad.onion%{REQUEST_URI}s" "expr=%{REQUEST_STATUS} == 200"

	# Set PHP's timezone to UTC
	php_admin_value date.timezone UTC

	# Enable rewrites
	RewriteEngine On

	# Special case for when request is '/'
	RewriteCond "%{REQUEST_URI}" "^/?$"
	RewriteRule ^/(.*)$ /index.php?page=index [QSA,L]

	# Redirect to the template if the content markdown file exists, but block when ending in '/index'
	RewriteCond ${WEB_DIRECTORY}/${SERVER_NAME}%{REQUEST_URI}.php !-f
	RewriteCond ${CONTENT_DIRECTORY}%{REQUEST_URI}.md -f
	RewriteCond "%{REQUEST_URI}" "!/index$"
	RewriteRule ^/(.+)$ /index.php?page=$1 [QSA,L]

	# Redirect to the template if the content markdown directory's index file exists
	RewriteCond ${WEB_DIRECTORY}/${SERVER_NAME}%{REQUEST_URI}.php !-f
	RewriteCond "%{REQUEST_URI}" "!/$"
	RewriteCond ${CONTENT_DIRECTORY}%{REQUEST_URI} -d
	RewriteCond ${CONTENT_DIRECTORY}%{REQUEST_URI}/index.md -f
	RewriteRule ^/(.+)$ /index.php?page=$1/index [QSA,L]

	# Remove the need for the .php extension for files that exist in the web directory
	RewriteCond ${WEB_DIRECTORY}/${SERVER_NAME}%{REQUEST_URI} !-d
	RewriteCond ${WEB_DIRECTORY}/${SERVER_NAME}%{REQUEST_URI}.php -f
	RewriteRule ^/(.+)$ %{REQUEST_URI}.php [L]

	# Error pages
	ErrorDocument 404 /index.php?error=true
</VirtualHost>
